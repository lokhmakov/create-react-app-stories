import { map, keyBy }             from 'lodash'

import generateQueryUpdated from 'engine/graphql/generate/query/updated'

export default ({ config, debug, methods }) => ({
  document: generateQueryUpdated(config),
  updateQuery: (prev, { subscriptionData }) => {
    debug(`graphql.updated.updateQuery()`)

    const { data = {}} = subscriptionData
    const { [methods.updated]: docList } = data
    const docMap = keyBy(docList, `id`)

    return {
      [methods.findAll]: {
        result: map(prev[methods.findAll].result, doc => docMap[doc.id] || doc),
        errors: prev[methods.findAll].errors,
      }
    }
  },
})
