import { find }             from 'lodash'

import generateQueryCreated from 'engine/graphql/generate/query/created'

export default ({ config, debug, methods }) => {
  return {
    document: generateQueryCreated(config),
    updateQuery: (prev, { subscriptionData }) => {
      debug(`graphql.created.updateQuery()`)

      const { data = {}} = subscriptionData
      const { [methods.created]: doc } = data

      if (find(prev[methods.findAll].result.slice(-10), { id: doc.id })) {
        return prev
      }

      return {
        [methods.findAll]: {
          result: [
            ...prev[methods.findAll].result,
            doc,
          ],
          errors: prev[methods.findAll].errors,
        }
      }
    },
  }
}
