import keyBy                from 'lodash/keyBy'
import { graphql }          from 'react-apollo'

import generateQueryFindAll from 'engine/graphql/generate/query/findAll'

export default ({ config, debug, methods, mapResult }) => (payload) => {
  const { options = {}, extraResult } = payload || {}
  return graphql(generateQueryFindAll({ ...config, extraResult }), {
    options,
    props: ({ data }) => {
      debug(`graphql.findAll.query()`)

      const { subscribeToMore, [methods.findAll]: resultData = {} } = data

      const { result: list = [], errors = [] } = resultData
      const errorsName = `${ config.name }Errors`
      const dataName = `${ config.name }Data`
      const orderName = `${ config.name }Order`

      const result = {
        [dataName]: keyBy(list, `id`),
        [errorsName]: errors,
        [orderName]: list.map(doc => doc.id),
        [methods.subscribeToMore]: subscribeToMore,
      }

      if (mapResult) return mapResult(result)

      return result
    },
  })
}
