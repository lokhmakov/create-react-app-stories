import { compose }          from 'redux'
import { createStore }      from 'redux'
import { applyMiddleware }  from 'redux'

import thunkMiddleware      from 'redux-thunk'
import window               from 'window-or-global'

import createReducer        from './createReducer'

import config               from '../config'

let store

export default (payload) => {
  if (store) return store

  const { client } = payload
  const composeEnhancers = window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose

  const { __SUBSYSTEMS__ = {} } = window

  store = createStore(
    createReducer({ client }),
    __SUBSYSTEMS__[config.name] || {},
    composeEnhancers(
      applyMiddleware(thunkMiddleware),
      applyMiddleware(client.middleware())
    )
  )

  return store
}
