import _                    from 'lodash'

import generateReference    from 'engine/sequelize/generate/reference'
import typeMap              from 'engine/sequelize/typeMap'

import getSequelize         from '../getSequelize'

export default function generateModel(payload) {
  const { fieldList, name, models } = payload
  const Model = getSequelize()
  const modelName = _.upperFirst(name)
  const modelDoc = {}

  let index = fieldList.length
  while(index--) {
    const doc = fieldList[index]
    if (typeMap.hasOwnProperty(doc.type)) {
      modelDoc[doc.name] = typeMap[doc.type](doc)
    }
  }

  const model = Model.define(modelName, modelDoc)

  index = fieldList.length
  while(index--) {
    const doc = fieldList[index]
    if (!typeMap.hasOwnProperty(doc.type)) {
      generateReference({ fieldDoc: doc, model, models})
    }
  }

  return model
}
