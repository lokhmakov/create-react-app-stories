import generatePassword     from 'password-generator'

import config               from '../config'
import debug                from '../debug'
import model                from '../model'

import compareCaptcha       from '../../captcha/api/compareCaptcha'
import createUser           from '../../user/api/createUser'
import sendEmail            from '../../../email/send'

import errors               from '../errors'

const userCreate = async ({ username, password }) => {
  try {
    await createUser({ username, password })
    return true
  } catch (err) {
    return false
  }
}

export default async (parent, payload, ctx) => {
  debug(`signup()`, payload)
  try {
    const { captchaValue, captchaText, username } = payload

    const captchaResult = await compareCaptcha({ captchaValue, captchaText })
    if (!captchaResult) {
      debug(`signup()`, `Captcha error`)
      return false
    }

    const password = generatePassword()

    if (!await userCreate({ username, password })) return false

    sendEmail({ to: username, subject: `Registration`, html: `password: ${ password }` })

    return true
  } catch (err) {
    debug(`signup()`, `ERROR`, err)
    return false
  }
}
