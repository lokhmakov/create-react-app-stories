import config               from '../config'
import debug                from '../debug'
import model                from '../model'

import checkPassword        from '../../user/api/checkPassword'

import errors               from '../errors'

const { tokenName } = config

export default async (parent, payload, ctx) => {
  debug(`login()`, payload)
  try {
    const { username, password } = payload
    const user = await checkPassword({ username, password })
    if (user) {
      const session = await model.create({ userId: user.id })
      if (ctx && ctx.res) {
        ctx.res.cookie(tokenName, session.id, { expires: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) })
      }
      return { result: session }
    }
    debug(`login()`, `WARNING`, errors.WRONG_USERNAME_OR_PASSWORD)
    return { result: null, errors: [ errors.WRONG_USERNAME_OR_PASSWORD ] }
  } catch (err) {
    debug(`login()`, `ERROR`, err)
    return {
      result: null,
      errors: [
        { message: err.message },
      ]
    }
  }
}
