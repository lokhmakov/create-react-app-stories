import map                  from 'lodash/map'


import storyLine            from '../../storyLine/model'

import debug                from '../debug'
import model                from '../model'
import errors               from '../errors'

export default async (parent, payload, ctx) => {
  debug(`custom.findAll()`, payload)
  try {
    const { where, limit = 50, offset = 0, order } = payload

    const list = await model.findAll({
      where,
      limit,
      offset,
      order: order ? map(order, ({ name, order }) => [name, order]) : [],
    })

    const result = []
    for (let instance of list) {
      const storyLineList = await storyLine.findAll({ where: { storyId: instance.id } })
      result.push({
        ...instance.get({ plain: true }),
        storyLineList: storyLineList || []
      })
    }

    return { result, errors: [] }
  } catch (err) {
    return {
      result: null,
      errors: [
        { code: 0, message: err }
      ],
    }
  }
}
